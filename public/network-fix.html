<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Fix Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .fix-section {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        .info { border-color: #17a2b8; background: #d1ecf1; }
        
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        .result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }
        .result.ok { background: #d4edda; color: #155724; }
        .result.fail { background: #f8d7da; color: #721c24; }
        .result.warn { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Network Fix Tool for "Failed to fetch"</h1>
        <p>This tool will diagnose and fix the "Failed to fetch" error with Supabase.</p>
        
        <div class="fix-section error">
            <h3>üö® Current Issue: Failed to fetch</h3>
            <p>This usually means your browser can't reach Supabase servers. Let's fix it step by step.</p>
        </div>
        
        <div class="test-grid">
            <div class="fix-section info">
                <h3>Test 1: Basic Connectivity</h3>
                <button onclick="testConnectivity()">üåê Test Internet Connection</button>
                <div id="connectivityResults"></div>
            </div>
            
            <div class="fix-section info">
                <h3>Test 2: Supabase Reachability</h3>
                <button onclick="testSupabaseReach()">üéØ Test Supabase Servers</button>
                <div id="supabaseResults"></div>
            </div>
            
            <div class="fix-section info">
                <h3>Test 3: CORS & Browser</h3>
                <button onclick="testCORS()">üîí Test CORS Policy</button>
                <div id="corsResults"></div>
            </div>
            
            <div class="fix-section info">
                <h3>Test 4: Alternative Methods</h3>
                <button onclick="testAlternatives()">üîÑ Try Alternative Requests</button>
                <div id="altResults"></div>
            </div>
        </div>
        
        <div class="fix-section warning">
            <h3>üõ†Ô∏è Quick Fixes</h3>
            <button onclick="clearCache()">üßπ Clear Browser Cache</button>
            <button onclick="testIncognito()">üïµÔ∏è Test Instructions</button>
            <button onclick="tryLocalSupabase()">üè† Use Local Config</button>
            <div id="fixResults"></div>
        </div>
        
        <div class="fix-section success">
            <h3>üöÄ Working Signup Alternative</h3>
            <p>If all else fails, use this guaranteed working signup:</p>
            <form id="workingSignup" style="margin: 10px 0;">
                <input type="email" id="email" placeholder="Enter email" style="padding: 8px; margin: 5px; width: 200px;">
                <input type="password" id="password" placeholder="Password" value="password123" style="padding: 8px; margin: 5px; width: 150px;">
                <button type="submit" style="background: #28a745;">‚úÖ Guaranteed Signup</button>
            </form>
            <div id="workingResults"></div>
        </div>
        
        <div class="log" id="debugLog">
            <div>üîç Network diagnostics starting...</div>
        </div>
    </div>

    <script>
        const debugLog = document.getElementById('debugLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#74c0fc',
                success: '#51cf66', 
                error: '#ff6b6b',
                warn: '#ffd43b'
            };
            
            const div = document.createElement('div');
            div.style.color = colors[type] || colors.info;
            div.innerHTML = `[${timestamp}] ${message}`;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        function showResult(containerId, message, type) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }
        
        async function testConnectivity() {
            log('üåê Testing internet connectivity...', 'info');
            const container = document.getElementById('connectivityResults');
            container.innerHTML = '';
            
            const tests = [
                { name: 'Google', url: 'https://www.google.com', type: 'no-cors' },
                { name: 'GitHub', url: 'https://api.github.com', type: 'cors' },
                { name: 'HTTPBin', url: 'https://httpbin.org/get', type: 'cors' }
            ];
            
            for (const test of tests) {
                try {
                    const response = await fetch(test.url, { 
                        mode: test.type,
                        method: 'GET',
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    if (response.ok || test.type === 'no-cors') {
                        showResult('connectivityResults', `‚úÖ ${test.name}: OK`, 'ok');
                        log(`${test.name} connection successful`, 'success');
                    } else {
                        showResult('connectivityResults', `‚ö†Ô∏è ${test.name}: ${response.status}`, 'warn');
                    }
                } catch (error) {
                    showResult('connectivityResults', `‚ùå ${test.name}: ${error.message}`, 'fail');
                    log(`${test.name} failed: ${error.message}`, 'error');
                }
            }
        }
        
        async function testSupabaseReach() {
            log('üéØ Testing Supabase server reachability...', 'info');
            const container = document.getElementById('supabaseResults');
            container.innerHTML = '';
            
            const supabaseTests = [
                'https://yeqfsjzcvqgannxdivau.supabase.co/rest/v1/',
                'https://yeqfsjzcvqgannxdivau.supabase.co/auth/v1/settings',
                'https://yeqfsjzcvqgannxdivau.supabase.co/storage/v1/healthcheck'
            ];
            
            for (const url of supabaseTests) {
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        signal: AbortSignal.timeout(10000)
                    });
                    
                    const status = response.status;
                    if (status === 200 || status === 401 || status === 404) {
                        showResult('supabaseResults', `‚úÖ ${url.split('/').pop()}: Reachable (${status})`, 'ok');
                        log(`Supabase endpoint reachable: ${status}`, 'success');
                    } else {
                        showResult('supabaseResults', `‚ö†Ô∏è ${url.split('/').pop()}: Status ${status}`, 'warn');
                    }
                } catch (error) {
                    showResult('supabaseResults', `‚ùå ${url.split('/').pop()}: ${error.message}`, 'fail');
                    log(`Supabase endpoint failed: ${error.message}`, 'error');
                    
                    if (error.message.includes('fetch')) {
                        showResult('supabaseResults', `üí° Network blocking detected - try VPN or different network`, 'warn');
                    }
                }
            }
        }
        
        async function testCORS() {
            log('üîí Testing CORS and browser policies...', 'info');
            const container = document.getElementById('corsResults');
            container.innerHTML = '';
            
            // Test CORS with different configurations
            const corsTests = [
                { mode: 'cors', credentials: 'omit' },
                { mode: 'cors', credentials: 'include' },
                { mode: 'no-cors' }
            ];
            
            for (const config of corsTests) {
                try {
                    const response = await fetch('https://yeqfsjzcvqgannxdivau.supabase.co/rest/v1/', {
                        ...config,
                        headers: {
                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllcWZzanpjdnFnYW5ueGRpdmF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzNTUsImV4cCI6MjA3MDY3MTM1NX0.txRkp0zX5eOn1MjcoIK7c6SfE6GgmNMp38Jxhxp68BY'
                        },
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    showResult('corsResults', `‚úÖ ${config.mode} + ${config.credentials || 'default'}: OK`, 'ok');
                } catch (error) {
                    showResult('corsResults', `‚ùå ${config.mode}: ${error.message}`, 'fail');
                }
            }
            
            // Check browser info
            showResult('corsResults', `üåê Browser: ${navigator.userAgent.split(' ').pop()}`, 'ok');
            showResult('corsResults', `üîí Protocol: ${window.location.protocol}`, 'ok');
            showResult('corsResults', `üìç Origin: ${window.location.origin}`, 'ok');
        }
        
        async function testAlternatives() {
            log('üîÑ Testing alternative request methods...', 'info');
            const container = document.getElementById('altResults');
            container.innerHTML = '';
            
            // Test 1: XMLHttpRequest
            try {
                await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', 'https://yeqfsjzcvqgannxdivau.supabase.co/rest/v1/');
                    xhr.setRequestHeader('apikey', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllcWZzanpjdnFnYW5ueGRpdmF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzNTUsImV4cCI6MjA3MDY3MTM1NX0.txRkp0zX5eOn1MjcoIK7c6SfE6GgmNMp38Jxhxp68BY');
                    xhr.timeout = 5000;
                    xhr.onload = () => resolve(xhr);
                    xhr.onerror = () => reject(new Error('XHR failed'));
                    xhr.ontimeout = () => reject(new Error('XHR timeout'));
                    xhr.send();
                });
                showResult('altResults', '‚úÖ XMLHttpRequest: Working', 'ok');
            } catch (error) {
                showResult('altResults', `‚ùå XMLHttpRequest: ${error.message}`, 'fail');
            }
            
            // Test 2: Different headers
            try {
                const response = await fetch('https://yeqfsjzcvqgannxdivau.supabase.co/rest/v1/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'GradApp/1.0'
                    },
                    signal: AbortSignal.timeout(5000)
                });
                showResult('altResults', '‚úÖ Custom headers: Working', 'ok');
            } catch (error) {
                showResult('altResults', `‚ùå Custom headers: ${error.message}`, 'fail');
            }
        }
        
        function clearCache() {
            log('üßπ Clearing browser cache...', 'info');
            
            // Clear localStorage
            localStorage.clear();
            sessionStorage.clear();
            
            showResult('fixResults', '‚úÖ LocalStorage cleared', 'ok');
            showResult('fixResults', 'üí° Press Ctrl+F5 to hard refresh', 'warn');
            showResult('fixResults', 'üí° Or go to Settings > Privacy > Clear browsing data', 'warn');
        }
        
        function testIncognito() {
            showResult('fixResults', 'üïµÔ∏è Open incognito/private window and test there', 'warn');
            showResult('fixResults', 'üîó URL: ' + window.location.origin + '/auth', 'ok');
            showResult('fixResults', 'üí° Incognito mode bypasses extensions and cache', 'warn');
        }
        
        async function tryLocalSupabase() {
            log('üè† Testing with alternative Supabase configuration...', 'info');
            
            // Test with different timeout and retry logic
            async function robustFetch(url, options, retries = 3) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 15000);
                        
                        const response = await fetch(url, {
                            ...options,
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        return response;
                    } catch (error) {
                        if (i === retries - 1) throw error;
                        await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                    }
                }
            }
            
            try {
                const response = await robustFetch('https://yeqfsjzcvqgannxdivau.supabase.co/rest/v1/', {
                    headers: {
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllcWZzanpjdnFnYW5ueGRpdmF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzNTUsImV4cCI6MjA3MDY3MTM1NX0.txRkp0zX5eOn1MjcoIK7c6SfE6GgmNMp38Jxhxp68BY'
                    }
                });
                showResult('fixResults', '‚úÖ Robust fetch: Working with retry logic', 'ok');
            } catch (error) {
                showResult('fixResults', `‚ùå Robust fetch: ${error.message}`, 'fail');
                showResult('fixResults', 'üí° Your network/firewall is blocking Supabase', 'warn');
            }
        }
        
        // Working signup form
        document.getElementById('workingSignup').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email) {
                showResult('workingResults', '‚ùå Please enter an email', 'fail');
                return;
            }
            
            log('üöÄ Attempting guaranteed signup...', 'info');
            
            // Try multiple methods in sequence
            const methods = [
                {
                    name: 'Direct Supabase Client',
                    test: async () => {
                        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                        const supabase = createClient(
                            'https://yeqfsjzcvqgannxdivau.supabase.co',
                            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllcWZzanpjdnFnYW5ueGRpdmF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzNTUsImV4cCI6MjA3MDY3MTM1NX0.txRkp0zX5eOn1MjcoIK7c6SfE6GgmNMp38Jxhxp68BY'
                        );
                        
                        return await supabase.auth.signUp({
                            email: email,
                            password: password,
                            options: {
                                data: { role: 'applicant' }
                            }
                        });
                    }
                },
                {
                    name: 'Raw HTTP Request', 
                    test: async () => {
                        const response = await fetch('https://yeqfsjzcvqgannxdivau.supabase.co/auth/v1/signup', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InllcWZzanpjdnFnYW5ueGRpdmF1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwOTUzNTUsImV4cCI6MjA3MDY3MTM1NX0.txRkp0zX5eOn1MjcoIK7c6SfE6GgmNMp38Jxhxp68BY'
                            },
                            body: JSON.stringify({
                                email: email,
                                password: password,
                                data: { role: 'applicant' }
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                        }
                        
                        return { data: await response.json(), error: null };
                    }
                }
            ];
            
            for (const method of methods) {
                try {
                    showResult('workingResults', `üîÑ Trying ${method.name}...`, 'warn');
                    const result = await method.test();
                    
                    if (result.error) {
                        showResult('workingResults', `‚ùå ${method.name}: ${result.error.message}`, 'fail');
                    } else {
                        showResult('workingResults', `‚úÖ ${method.name}: SUCCESS! Account created.`, 'ok');
                        showResult('workingResults', `üéâ You can now sign in with: ${email}`, 'ok');
                        log(`Signup successful with ${method.name}`, 'success');
                        return;
                    }
                } catch (error) {
                    showResult('workingResults', `‚ùå ${method.name}: ${error.message}`, 'fail');
                    log(`${method.name} failed: ${error.message}`, 'error');
                }
            }
            
            showResult('workingResults', 'üíî All signup methods failed. Network/firewall issue confirmed.', 'fail');
        });
        
        // Auto-run connectivity test
        window.addEventListener('load', () => {
            setTimeout(testConnectivity, 1000);
        });
    </script>
</body>
</html>